<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Talk2Translate â€” CanlÄ± Ã‡eviri</title>
<meta name="color-scheme" content="dark light" />
<style>
  :root{
    --bg1:#0b1220; --bg2:#111827;
    --ink:#e5e7eb; --muted:#9ca3af;
    --glass:rgba(255,255,255,.06); --line:rgba(255,255,255,.12);
    --accent:#ec4899; --accent2:#8b5cf6;
    --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:ui-sans-serif,system-ui,Arial,Segoe UI,Roboto;
    background:radial-gradient(1200px 600px at 10% 0%,#1e293b 0%,transparent 60%),
               radial-gradient(1200px 600px at 100% 0%,#0ea5e9 0%,transparent 50%),
               linear-gradient(180deg,var(--bg1),var(--bg2));
    color:var(--ink); display:flex; justify-content:center; padding:22px;
  }
  .wrap{width:min(980px,100%)}
  .card{
    background:var(--glass); border:1px solid var(--line); border-radius:22px; padding:18px 18px 16px;
    backdrop-filter:blur(16px); box-shadow:0 12px 32px rgba(0,0,0,.35);
  }
  header{display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:12px}
  h1{margin:0; font-size:22px; letter-spacing:.3px}
  .badges{display:flex; gap:8px; flex-wrap:wrap}
  .badge{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:rgba(255,255,255,.08)}
  .ok{background:rgba(16,185,129,.16)} .warn{background:rgba(245,158,11,.16)} .err{background:rgba(239,68,68,.16)}
  .controls{display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px}
  select,button,textarea,input[type="checkbox"]{accent-color:var(--accent)}
  select,button,textarea{
    border:none; border-radius:12px; padding:10px 12px; font-size:15px;
    color:var(--ink); background:rgba(255,255,255,.08);
  }
  button{
    cursor:pointer; background:linear-gradient(135deg,var(--accent),var(--accent2)); font-weight:700;
    border:0; transition:filter .15s ease, transform .02s;
  }
  button.secondary{background:rgba(255,255,255,.08); border:1px solid var(--line); font-weight:600}
  button:disabled{opacity:.55; cursor:not-allowed}
  button:active{transform:translateY(1px)}
  .pill{padding:8px 12px; border-radius:999px; border:1px dashed var(--line); font-size:13px; display:flex; align-items:center; gap:8px}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:14px}
  @media(max-width:860px){.grid{grid-template-columns:1fr}}
  .box{background:rgba(255,255,255,.05); border:1px solid var(--line); border-radius:16px; padding:12px; min-height:120px; display:flex; flex-direction:column}
  .box h3{margin:0 0 8px; font-size:14px; color:var(--muted)}
  .view{flex:1; background:rgba(0,0,0,.25); border-radius:12px; padding:10px; overflow:auto; line-height:1.55; word-wrap:break-word; white-space:pre-wrap}
  textarea{width:100%; resize:vertical; min-height:90px}
  .bar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:8px}
  .diag{margin-top:12px; font-size:13px; color:var(--muted); line-height:1.5}
  footer{margin-top:12px; font-size:12px; color:var(--muted); text-align:center}
  .sr-only{position:absolute;clip:rect(1px,1px,1px,1px);padding:0;border:0;height:1px;width:1px;overflow:hidden;white-space:nowrap}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <h1>ğŸ¤ Talk2Translate</h1>
      <div class="badges">
        <span id="httpsBadge" class="badge">HTTPS kontrol...</span>
        <span id="srBadge" class="badge">TanÄ±ma hazÄ±rlanÄ±yor...</span>
        <span id="micBadge" class="badge">Mikrofon...</span>
      </div>
    </header>

    <div class="controls" role="group" aria-label="Kontroller">
      <label class="sr-only" for="sourceLang">Kaynak Dil</label>
      <select id="sourceLang">
        <option value="tr-TR" data-iso="tr" selected>TÃ¼rkÃ§e</option>
        <option value="en-US" data-iso="en">Ä°ngilizce</option>
        <option value="de-DE" data-iso="de">Almanca</option>
        <option value="fr-FR" data-iso="fr">FransÄ±zca</option>
        <option value="es-ES" data-iso="es">Ä°spanyolca</option>
        <option value="ru-RU" data-iso="ru">RusÃ§a</option>
        <option value="ar-SA" data-iso="ar">ArapÃ§a</option>
      </select>

      <label class="sr-only" for="targetLang">Hedef Dil</label>
      <select id="targetLang">
        <option value="en">Ä°ngilizce</option>
        <option value="tr" selected>TÃ¼rkÃ§e</option>
        <option value="de">Almanca</option>
        <option value="fr">FransÄ±zca</option>
        <option value="es">Ä°spanyolca</option>
        <option value="ru">RusÃ§a</option>
        <option value="ar">ArapÃ§a</option>
      </select>

      <button id="startBtn">Dinlemeyi BaÅŸlat</button>
      <button id="stopBtn" class="secondary" disabled>Durdur</button>
      <label class="pill" title="Android iÃ§in Ã¶nerilir: TanÄ±ma bitince otomatik yeniden baÅŸlatÄ±r">
        <input type="checkbox" id="continuous" checked /> SÃ¼rekli Dinleme
      </label>
      <label class="pill" title="Ã‡eviri otomatik sesle okunsun mu?">
        <input type="checkbox" id="autoSpeak" checked /> Otomatik Oku
      </label>
      <button id="speakBtn" class="secondary" disabled>ğŸ”Š Oku</button>
    </div>

    <div class="grid">
      <div class="box">
        <h3>AlgÄ±lanan</h3>
        <div id="recognizedText" class="view">â€”</div>
      </div>
      <div class="box">
        <h3>Ã‡evrilen</h3>
        <div id="translatedText" class="view">â€”</div>
      </div>
    </div>

    <div class="box" style="margin-top:14px">
      <h3>Manuel Mod</h3>
      <textarea id="manualInput" placeholder="Metni yaz..."></textarea>
      <div class="bar">
        <button id="manualTranslateBtn">Ã‡evir</button>
        <span id="lastError" class="badge">Son hata: yok</span>
      </div>
    </div>

    <div class="diag" id="diag">
      ğŸ” TanÄ±lama: bekleniyor...
    </div>

    <footer>Ses tanÄ±ma: Web Speech API â€¢ Ã‡eviri: MyMemory â€¢ En iyi deneyim: HTTPS + gÃ¼ncel Chrome/Edge</footer>
  </div>
</div>

<script>
/* --------- Elemanlar --------- */
const recognizedEl = document.getElementById('recognizedText');
const translatedEl = document.getElementById('translatedText');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const speakBtn = document.getElementById('speakBtn');
const autoSpeak = document.getElementById('autoSpeak');
const manualInput = document.getElementById('manualInput');
const manualTranslateBtn = document.getElementById('manualTranslateBtn');
const sourceSel = document.getElementById('sourceLang');
const targetSel = document.getElementById('targetLang');
const httpsBadge = document.getElementById('httpsBadge');
const srBadge = document.getElementById('srBadge');
const micBadge = document.getElementById('micBadge');
const diag = document.getElementById('diag');
const lastErrorEl = document.getElementById('lastError');
const continuousCB = document.getElementById('continuous');

const setBadge = (el, text, cls) => { el.className = `badge ${cls||''}`; el.textContent = text; };
const setError = (msg) => lastErrorEl.textContent = `Son hata: ${msg}`;

const isHttps = location.protocol === 'https:' || ['localhost','127.0.0.1'].includes(location.hostname);
setBadge(httpsBadge, isHttps ? 'HTTPS âœ”' : 'HTTPS Ã¶nerilir', isHttps ? 'ok' : 'warn');

let recognition = null;
let listening = false;
let lastTranslated = '';

/* --------- Destek kontrolÃ¼ --------- */
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!SR) {
  setBadge(srBadge,'TarayÄ±cÄ± desteklemiyor','err');
  diag.textContent = 'Bu tarayÄ±cÄ± Web Speech APIâ€™yi desteklemiyor. (Alternatif: Vosk â€” model gerekir.)';
} else {
  setBadge(srBadge,'HazÄ±r','ok');
}

/* --------- Mikrofon iznini erkenden iste --------- */
async function preAskMic() {
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    // izin alÄ±ndÄ±ktan sonra stream'i durdur (boÅŸuna aÃ§Ä±k kalmasÄ±n)
    stream.getTracks().forEach(t => t.stop());
    setBadge(micBadge,'Mikrofon âœ”','ok');
    return true;
  }catch(e){
    setBadge(micBadge,'Mikrofon izni yok','err');
    setError('Mikrofon izni verilmedi');
    diag.textContent = 'Mikrofon izni verilmedi. LÃ¼tfen Ä°zin ver â†’ sonra tekrar deneyin.';
    return false;
  }
}

/* --------- TanÄ±ma kurulum --------- */
function setupRecognition() {
  if (!SR) return null;
  const rec = new SR();
  rec.lang = sourceSel.value;            // Ã¶rn: tr-TR
  rec.interimResults = true;
  rec.maxAlternatives = 1;
  rec.continuous = true; // Android iÃ§in daha stabil

  rec.onstart = () => {
    recognizedEl.textContent = 'Dinleniyor...';
    diag.textContent = `TanÄ±ma baÅŸladÄ± (${rec.lang}). KonuÅŸmaya baÅŸlayÄ±n.`;
    setBadge(srBadge,'Dinleniyor','ok');
    startBtn.disabled = true; stopBtn.disabled = false;
  };

  rec.onresult = (e) => {
    const res = e.results[e.results.length - 1];
    const txt = res[0].transcript;
    if (res.isFinal) {
      recognizedEl.textContent = txt;
      translateText(txt);
    } else {
      recognizedEl.textContent = (txt || '') + ' â€¦';
    }
  };

  rec.onerror = (e) => {
    setBadge(srBadge,'Hata','err');
    const err = e.error || 'tanÄ±ma hatasÄ±';
    setError(err);
    diag.textContent = `Hata: ${err}`;
    // bazÄ± hatalarda (no-speech, network) kÄ±sa bekleme ile yeniden baÅŸlatmak iÅŸe yarar
    if (listening && continuousCB.checked) {
      try { rec.stop(); } catch {}
      setTimeout(()=>{ try{ rec.start(); }catch{} }, 400);
    }
  };

  rec.onend = () => {
    startBtn.disabled = false; stopBtn.disabled = true;
    setBadge(srBadge,'HazÄ±r','ok');
    // Android Chrome'da onend sÄ±k tetiklenir; continuous aÃ§Ä±ksa yeniden baÅŸlat
    if (listening && continuousCB.checked) {
      setTimeout(()=>{ try{ rec.start(); }catch{} }, 250);
    }
  };

  return rec;
}

/* --------- Ã‡eviri (MyMemory) --------- */
async function translateText(text) {
  translatedEl.textContent = 'Ã‡evriliyor...';
  const srcISO = sourceSel.selectedOptions[0].dataset.iso; // tr, en, ...
  const tgtISO = targetSel.value;                          // tr, en, ...
  try{
    const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${srcISO}|${tgtISO}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('AÄŸ/CORS hatasÄ±');
    const data = await res.json();
    const out = data?.responseData?.translatedText || '';
    if (!out) throw new Error('BoÅŸ Ã§eviri');
    translatedEl.textContent = out;
    lastTranslated = out;
    speakBtn.disabled = false;
    setError('yok');
    if (autoSpeak.checked) speakNow();
  }catch(e){
    translatedEl.textContent = 'Ã‡eviri hatasÄ±!';
    speakBtn.disabled = true;
    setError(e.message || 'Ã‡eviri hatasÄ±');
  }
}

/* --------- Sesli okuma --------- */
function speakNow(){
  if (!lastTranslated) return;
  const u = new SpeechSynthesisUtterance(lastTranslated);
  const voiceMap = { tr:'tr-TR', en:'en-US', de:'de-DE', fr:'fr-FR', es:'es-ES', ru:'ru-RU', ar:'ar-SA' };
  u.lang = voiceMap[targetSel.value] || 'en-US';
  speechSynthesis.speak(u);
}
speakBtn.addEventListener('click', speakNow);

/* --------- Manuel Mod --------- */
manualTranslateBtn.addEventListener('click', ()=>{
  const text = manualInput.value.trim();
  if (!text) return;
  recognizedEl.textContent = text;
  translateText(text);
});

/* --------- BaÅŸlat/Durdur --------- */
startBtn.addEventListener('click', async ()=>{
  if (!SR) { setError('TarayÄ±cÄ± desteklemiyor'); return; }
  const ok = await preAskMic();
  if (!ok) return;
  if (!recognition) recognition = setupRecognition();
  try { recognition.lang = sourceSel.value; } catch {}
  listening = true;
  try { recognition.start(); }
  catch(e){ /* already started vs. */ }
});

stopBtn.addEventListener('click', ()=>{
  listening = false;
  try{ recognition && recognition.stop(); }catch{}
});

/* --------- Ä°lk tanÄ±lama --------- */
(async ()=>{
  const httpsOk = isHttps;
  const micOk = await preAskMic();
  const srOk = !!SR;
  setBadge(httpsBadge, httpsOk ? 'HTTPS âœ”' : 'HTTPS Ã¶nerilir', httpsOk ? 'ok':'warn');
  setBadge(srBadge, srOk ? 'HazÄ±r':'TarayÄ±cÄ± desteklemiyor', srOk ? 'ok':'err');
  setBadge(micBadge, micOk ? 'Mikrofon âœ”':'Mikrofon izni yok', micOk ? 'ok':'err');

  diag.innerHTML = [
    `TarayÄ±cÄ± desteÄŸi: ${srOk ? 'âœ… Var' : 'âŒ Yok'}`,
    `HTTPS: ${httpsOk ? 'âœ… Evet' : 'âš ï¸ Ã–nerilir'}`,
    `Mikrofon izni: ${micOk ? 'âœ… Verildi' : 'âŒ Yok'}`,
    `SÃ¼rekli Dinleme: ${continuousCB.checked ? 'AÃ§Ä±k' : 'KapalÄ±'}`
  ].join(' â€¢ ');
})();
</script>
</body>
</html>
