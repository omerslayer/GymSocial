<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Talk2Translate ‚Äî Web Speech + MyMemory</title>
<style>
  :root{
    --bg1:#0b1220; --bg2:#111827;
    --ink:#e5e7eb; --muted:#9ca3af;
    --glass:rgba(255,255,255,.06); --line:rgba(255,255,255,.12);
    --accent:#ec4899; --accent2:#8b5cf6;
    --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; font-family:ui-sans-serif,system-ui,Arial;
    background:radial-gradient(1200px 600px at 10% 0%,#1e293b 0%,transparent 60%),
               radial-gradient(1200px 600px at 100% 0%,#0ea5e9 0%,transparent 50%),
               linear-gradient(180deg,var(--bg1),var(--bg2));
    color:var(--ink); display:flex; justify-content:center; padding:24px;
  }
  .wrap{width:min(960px,100%)}
  .card{
    background:var(--glass); border:1px solid var(--line); border-radius:20px; padding:18px;
    backdrop-filter:blur(16px); box-shadow:0 10px 30px rgba(0,0,0,.35);
  }
  header{display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:12px}
  h1{margin:0; font-size:22px}
  .badges{display:flex; gap:8px; flex-wrap:wrap}
  .badge{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:rgba(255,255,255,.08)}
  .ok{background:rgba(16,185,129,.15)} .warn{background:rgba(245,158,11,.15)} .err{background:rgba(239,68,68,.15)}
  .controls{display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px}
  select,button,textarea{
    border:none; border-radius:12px; padding:10px 12px; font-size:15px;
    color:var(--ink); background:rgba(255,255,255,.08);
  }
  button{cursor:pointer; background:linear-gradient(135deg,var(--accent),var(--accent2)); font-weight:700}
  button.secondary{background:rgba(255,255,255,.08); border:1px solid var(--line); font-weight:600}
  button:disabled{opacity:.55; cursor:not-allowed}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:14px}
  @media(max-width:860px){.grid{grid-template-columns:1fr}}
  .box{background:rgba(255,255,255,.05); border:1px solid var(--line); border-radius:16px; padding:12px; min-height:120px; display:flex; flex-direction:column}
  .box h3{margin:0 0 8px; font-size:14px; color:var(--muted)}
  .view{flex:1; background:rgba(0,0,0,.25); border-radius:12px; padding:10px; overflow:auto; line-height:1.55}
  textarea{width:100%; resize:vertical; min-height:90px}
  .bar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:8px}
  .diag{margin-top:10px; font-size:13px; color:var(--muted); line-height:1.5}
  footer{margin-top:14px; font-size:12px; color:var(--muted); text-align:center}
  .pill{padding:6px 10px; border-radius:999px; border:1px dashed var(--line); font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <h1>üé§ Talk2Translate</h1>
      <div class="badges">
        <span id="httpsBadge" class="badge">HTTPS kontrol...</span>
        <span id="srBadge" class="badge">Tanƒ±ma hazƒ±rlƒ±k...</span>
        <span id="micBadge" class="badge">Mikrofon...</span>
      </div>
    </header>

    <div class="controls">
      <!-- Kaynak (tanƒ±nacak) dil -->
      <select id="sourceLang">
        <option value="tr-TR" data-iso="tr" selected>T√ºrk√ße</option>
        <option value="en-US" data-iso="en">ƒ∞ngilizce</option>
        <option value="de-DE" data-iso="de">Almanca</option>
        <option value="fr-FR" data-iso="fr">Fransƒ±zca</option>
        <option value="es-ES" data-iso="es">ƒ∞spanyolca</option>
        <option value="ru-RU" data-iso="ru">Rus√ßa</option>
        <option value="ar-SA" data-iso="ar">Arap√ßa</option>
      </select>

      <!-- Hedef (√ßeviri) dil -->
      <select id="targetLang">
        <option value="en">ƒ∞ngilizce</option>
        <option value="tr" selected>T√ºrk√ße</option>
        <option value="de">Almanca</option>
        <option value="fr">Fransƒ±zca</option>
        <option value="es">ƒ∞spanyolca</option>
        <option value="ru">Rus√ßa</option>
        <option value="ar">Arap√ßa</option>
      </select>

      <button id="startBtn">Dinlemeyi Ba≈ülat</button>
      <button id="stopBtn" class="secondary" disabled>Durdur</button>
      <label class="pill" title="√áeviri otomatik sesle okunsun mu?"><input type="checkbox" id="autoSpeak" checked> Otomatik Oku</label>
      <button id="speakBtn" class="secondary" disabled>üîä Oku</button>
    </div>

    <div class="grid">
      <div class="box">
        <h3>Algƒ±lanan</h3>
        <div id="recognizedText" class="view">‚Äî</div>
      </div>
      <div class="box">
        <h3>√áevrilen</h3>
        <div id="translatedText" class="view">‚Äî</div>
      </div>
    </div>

    <div class="box" style="margin-top:14px">
      <h3>Manuel Mod</h3>
      <textarea id="manualInput" placeholder="Metni yaz..."></textarea>
      <div class="bar">
        <button id="manualTranslateBtn">√áevir</button>
        <span id="lastError" class="badge">Son hata: yok</span>
      </div>
    </div>

    <div class="diag" id="diag">
      üîç Tanƒ±lama: bekleniyor...
    </div>

    <footer>Ses tanƒ±ma: Web Speech API ‚Ä¢ √áeviri: MyMemory ‚Ä¢ En iyi deneyim i√ßin HTTPS + Chrome/Edge</footer>
  </div>
</div>

<script>
/* ---- Elemanlar ---- */
const recognizedEl = document.getElementById('recognizedText');
const translatedEl = document.getElementById('translatedText');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const speakBtn = document.getElementById('speakBtn');
const autoSpeak = document.getElementById('autoSpeak');
const manualInput = document.getElementById('manualInput');
const manualTranslateBtn = document.getElementById('manualTranslateBtn');
const sourceSel = document.getElementById('sourceLang');
const targetSel = document.getElementById('targetLang');
const httpsBadge = document.getElementById('httpsBadge');
const srBadge = document.getElementById('srBadge');
const micBadge = document.getElementById('micBadge');
const diag = document.getElementById('diag');
const lastErrorEl = document.getElementById('lastError');

const setBadge = (el, text, cls) => { el.className = `badge ${cls||''}`; el.textContent = text; };
const setError = (msg) => lastErrorEl.textContent = `Son hata: ${msg}`;
const isHttps = location.protocol === 'https:' || ['localhost','127.0.0.1'].includes(location.hostname);
setBadge(httpsBadge, isHttps ? 'HTTPS ‚úî' : 'HTTPS √∂nerilir', isHttps ? 'ok' : 'warn');

let recognition = null;
let listening = false;
let lastTranslated = '';

/* ---- Destek kontrol√º ---- */
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!SR) {
  setBadge(srBadge,'Tarayƒ±cƒ± desteklemiyor','err');
  diag.textContent = 'Bu tarayƒ±cƒ± Web Speech API‚Äôyi desteklemiyor. Alternatif: Vosk (model dosyasƒ± gerekli).';
} else {
  setBadge(srBadge,'Hazƒ±r','ok');
}

/* ---- Mikrofon izni erkenden iste ---- */
async function preAskMic() {
  try{
    await navigator.mediaDevices.getUserMedia({audio:true});
    setBadge(micBadge,'Mikrofon ‚úî','ok');
    return true;
  }catch(e){
    setBadge(micBadge,'Mikrofon izni yok','err');
    setError('Mikrofon izni verilmedi');
    diag.textContent = 'Mikrofon izni verilmedi. L√ºtfen ƒ∞zin ver ‚Üí sonra tekrar deneyin.';
    return false;
  }
}

/* ---- Tanƒ±ma kur ve ba≈ülat ---- */
function setupRecognition() {
  if (!SR) return null;
  const rec = new SR();
  rec.lang = sourceSel.value;            // √∂rn: tr-TR
  rec.interimResults = true;
  rec.maxAlternatives = 1;

  rec.onstart = () => {
    recognizedEl.textContent = 'Dinleniyor...';
    diag.textContent = `Tanƒ±ma ba≈üladƒ± (${rec.lang}). Konu≈ümaya ba≈ülayƒ±n.`;
    setBadge(srBadge,'Dinleniyor','ok');
    startBtn.disabled = true; stopBtn.disabled = false;
  };

  rec.onresult = (e) => {
    // Son kƒ±sƒ±m
    const res = e.results[e.results.length - 1];
    const txt = res[0].transcript;
    if (res.isFinal) {
      recognizedEl.textContent = txt;
      translateText(txt);
    } else {
      recognizedEl.textContent = (txt || '') + ' ‚Ä¶';
    }
  };

  rec.onerror = (e) => {
    setBadge(srBadge,'Hata','err');
    setError(e.error || 'tanƒ±ma hatasƒ±');
    diag.textContent = `Hata: ${e.error || 'bilinmiyor'}`;
  };

  // Android‚Äôde bazen kendiliƒüinden erken kapanƒ±r; burada durumu normalize ediyoruz
  rec.onend = () => {
    startBtn.disabled = false; stopBtn.disabled = true;
    setBadge(srBadge,'Hazƒ±r','ok');
    if (listening) {
      // Kƒ±sa aradan sonra yeniden ba≈ülat (Android i√ßin pratik √ß√∂z√ºm)
      setTimeout(()=>{ try{ rec.start(); }catch{} }, 250);
    }
  };

  return rec;
}

/* ---- √áeviri (MyMemory) ---- */
async function translateText(text) {
  translatedEl.textContent = '√áevriliyor...';
  const srcISO = sourceSel.selectedOptions[0].dataset.iso; // tr, en, ...
  const tgtISO = targetSel.value;                          // tr, en, ...
  try{
    const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${srcISO}|${tgtISO}`;
    const res = await fetch(url);
    const data = await res.json();
    const out = data?.responseData?.translatedText || '';
    if (!out) throw new Error('Bo≈ü √ßeviri');
    translatedEl.textContent = out;
    lastTranslated = out;
    speakBtn.disabled = false;
    setError('yok');
    if (autoSpeak.checked) speakNow();
  }catch(e){
    translatedEl.textContent = '√áeviri hatasƒ±!';
    speakBtn.disabled = true;
    setError(e.message || '√áeviri hatasƒ±');
  }
}

/* ---- Sesli okuma ---- */
function speakNow(){
  if (!lastTranslated) return;
  const u = new SpeechSynthesisUtterance(lastTranslated);
  const voiceMap = { tr:'tr-TR', en:'en-US', de:'de-DE', fr:'fr-FR', es:'es-ES', ru:'ru-RU', ar:'ar-SA' };
  u.lang = voiceMap[targetSel.value] || 'en-US';
  speechSynthesis.speak(u);
}
speakBtn.addEventListener('click', speakNow);

/* ---- Manuel Mod ---- */
manualTranslateBtn.addEventListener('click', ()=>{
  const text = manualInput.value.trim();
  if (!text) return;
  recognizedEl.textContent = text;
  translateText(text);
});

/* ---- Ba≈ülat/Durdur ---- */
startBtn.addEventListener('click', async ()=>{
  if (!SR) return;
  const ok = await preAskMic();
  if (!ok) return;
  if (!recognition) recognition = setupRecognition();
  // Se√ßilen dile g√∂re g√ºncelle
  try{ recognition.lang = sourceSel.value; }catch{}
  listening = true;
  try{ recognition.start(); }
  catch(e){ /* "already started" hatasƒ± olursa g√∂rmezden gel */ }
});

stopBtn.addEventListener('click', ()=>{
  listening = false;
  try{ recognition && recognition.stop(); }catch{}
});

/* ---- ƒ∞lk tanƒ±lama ---- */
(async ()=>{
  const httpsOk = isHttps;
  const micOk = await preAskMic();
  const srOk = !!SR;
  setBadge(httpsBadge, httpsOk ? 'HTTPS ‚úî' : 'HTTPS √∂nerilir', httpsOk ? 'ok':'warn');
  setBadge(srBadge, srOk ? 'Hazƒ±r':'Tarayƒ±cƒ± desteklemiyor', srOk ? 'ok':'err');
  setBadge(micBadge, micOk ? 'Mikrofon ‚úî':'Mikrofon izni yok', micOk ? 'ok':'err');

  diag.innerHTML = [
    `Tarayƒ±cƒ± desteƒüi: ${srOk ? '‚úÖ Var' : '‚ùå Yok'}`,
    `HTTPS: ${httpsOk ? '‚úÖ Evet' : '‚ö†Ô∏è √ñnerilir'}`,
    `Mikrofon izni: ${
