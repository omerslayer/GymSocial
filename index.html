<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>GymSocial — Athletes Only</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  :root{
    --bg:#0f1115; --card:#151821; --muted:#8e99a8; --text:#e9eef5;
    --brand:#6cf; --accent:#4ade80; --danger:#ef4444; --line:#242938;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  a{color:inherit}
  header{position:sticky;top:0;z-index:10;background:#0d1016;border-bottom:1px solid var(--line)}
  .nav{display:flex;align-items:center;gap:10px;max-width:980px;margin:0 auto;padding:10px 16px}
  .logo{font-weight:700;letter-spacing:.3px}
  .tabs{display:flex;gap:8px;margin-left:auto;flex-wrap:wrap}
  .tab{border:1px solid var(--line);background:transparent;color:var(--text);padding:8px 10px;border-radius:8px;cursor:pointer}
  .tab.active,.btn.primary{background:var(--brand);color:#081018;border-color:transparent;font-weight:600}
  main{max-width:980px;margin:12px auto;padding:12px}
  .grid{display:grid;grid-template-columns:1fr 300px;gap:16px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0f1320;color:var(--text)}
  textarea{min-height:80px;resize:vertical}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row>div{flex:1 1 160px}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#131a2a;color:var(--text);cursor:pointer}
  .btn.danger{background:#2a1416;border-color:#4b1f25;color:#ffb4b4}
  .btn.ghost{background:transparent}
  .muted{color:var(--muted);font-size:.92em}
  .list{display:flex;flex-direction:column;gap:10px}
  .post{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0e1220}
  .post .top{display:flex;gap:10px;align-items:center;padding:10px;border-bottom:1px solid var(--line)}
  .avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid #0003;background:#222}
  .big-avatar{width:84px;height:84px;border-radius:50%;object-fit:cover;border:2px solid var(--line)}
  .post img.media{width:100%;max-height:520px;object-fit:cover;background:#0b0f1a}
  .post .actions{display:flex;gap:8px;padding:10px;border-top:1px solid var(--line)}
  .chip{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid var(--line);border-radius:999px}
  .stories{display:flex;gap:10px;overflow-x:auto;padding-bottom:6px}
  .story{display:flex;flex-direction:column;align-items:center;gap:6px}
  .story img{width:62px;height:62px;border-radius:50%;object-fit:cover;border:2px solid var(--brand)}
  .hidden{display:none !important}
  .hr{height:1px;background:var(--line);margin:12px 0}
  .link{cursor:pointer;color:var(--brand)}
</style>

<!-- Firebase v8 (compatible with GitHub Pages no-bundler setup) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
</head>
<body>

<header>
  <div class="nav">
    <div class="logo">GymSocial</div>
    <div class="tabs">
      <button class="tab active" data-screen="feed">Feed</button>
      <button class="tab" data-screen="upload">Upload</button>
      <button class="tab" data-screen="stories">Stories</button>
      <button class="tab" data-screen="messages">Messages</button>
      <button class="tab" data-screen="discover">Users</button>
      <button class="tab" data-screen="requests">Requests</button>
      <button class="tab" data-screen="profile">Profile</button>
      <button id="logoutBtn" class="tab">Logout</button>
    </div>
  </div>
</header>

<main>
  <!-- AUTH -->
  <section id="auth" class="grid">
    <div class="card">
      <h3>Welcome to GymSocial</h3>
      <p class="muted">Create an account or login to join the athletes-only community.</p>
      <div class="row">
        <div><input id="email" type="email" placeholder="Email" /></div>
        <div><input id="password" type="password" placeholder="Password" /></div>
      </div>
      <div class="row">
        <button class="btn primary" onclick="register()">Sign Up</button>
        <button class="btn" onclick="login()">Login</button>
      </div>
      <div class="hr"></div>
      <p class="muted">After login, complete your athlete profile and start posting.</p>
    </div>
    <div class="card">
      <h4>Live Setup Tips</h4>
      <ol class="muted">
        <li>Enable <b>Authentication → Email/Password</b>.</li>
        <li>Start <b>Firestore</b> (test mode for dev).</li>
        <li>Start <b>Storage</b> (allow image uploads).</li>
      </ol>
      <p class="muted">This demo uses client SDK only, perfect for GitHub Pages.</p>
    </div>
  </section>

  <!-- FEED -->
  <section id="feed" class="hidden grid">
    <div>
      <div class="card">
        <div class="stories" id="storiesBar"></div>
      </div>
      <div id="feedList" class="list"></div>
    </div>
    <aside class="card">
      <h4>Your Info</h4>
      <div id="meCard"></div>
      <div class="hr"></div>
      <div id="quickActions"></div>
    </aside>
  </section>

  <!-- UPLOAD -->
  <section id="upload" class="hidden grid">
    <div class="card">
      <h3>Create a Post</h3>
      <input id="postImage" type="file" accept="image/*" />
      <textarea id="postCaption" placeholder="Write a caption..."></textarea>
      <button class="btn primary" onclick="createPost()">Publish</button>
      <p class="muted">Photos are stored in Firebase Storage.</p>
    </div>
    <div class="card">
      <h3>Add a Story</h3>
      <input id="storyImage" type="file" accept="image/*" />
      <button class="btn" onclick="createStory()">Share Story</button>
      <p class="muted">Stories expire after 24 hours.</p>
    </div>
  </section>

  <!-- MESSAGES -->
  <section id="messages" class="hidden grid">
    <div class="card">
      <h3>Direct Messages</h3>
      <div class="row">
        <div><input id="dmToEmail" placeholder="User email to chat" /></div>
        <div><button class="btn" onclick="openConversation()">Open Chat</button></div>
      </div>
      <div id="dmBox" class="card hidden">
        <div id="dmHeader" class="muted"></div>
        <div id="dmMessages" style="height:320px;overflow:auto;border:1px solid var(--line);border-radius:8px;margin:10px 0;padding:8px;background:#0c1120"></div>
        <div class="row">
          <div><input id="dmInput" placeholder="Type a message..." /></div>
          <div><button class="btn primary" onclick="sendDM()">Send</button></div>
        </div>
      </div>
    </div>
  </section>

  <!-- DISCOVER USERS -->
  <section id="discover" class="hidden grid">
    <div class="card">
      <h3>Discover Athletes</h3>
      <div id="userList" class="list"></div>
    </div>
  </section>

  <!-- FOLLOW REQUESTS -->
  <section id="requests" class="hidden grid">
    <div class="card">
      <h3>Follow Requests</h3>
      <div id="reqList" class="list"></div>
    </div>
  </section>

  <!-- PROFILE -->
  <section id="profile" class="hidden grid">
    <div class="card">
      <h3>Your Athlete Profile</h3>
      <div class="row">
        <div><img id="profileAvatar" class="big-avatar" alt=""></div>
        <div style="flex:2">
          <input id="displayName" placeholder="Display name (e.g. JohnD)" />
          <select id="isPrivate">
            <option value="false">Public account</option>
            <option value="true">Private account</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div><input id="height" type="number" placeholder="Height (cm)"></div>
        <div><input id="weight" type="number" placeholder="Weight (kg)"></div>
        <div><input id="age" type="number" placeholder="Age"></div>
      </div>
      <div class="row">
        <div><input id="bench" type="number" placeholder="Max Bench (≤300)"></div>
        <div><input id="squat" type="number" placeholder="Max Squat (≤300)"></div>
        <div><input id="pullups" type="number" placeholder="Max Pull-ups (≤70)"></div>
        <div><input id="pushups" type="number" placeholder="Max Push-ups (≤200)"></div>
      </div>
      <div class="row">
        <div><input id="avatarFile" type="file" accept="image/*"></div>
        <div><button class="btn" onclick="uploadAvatar()">Upload Avatar</button></div>
      </div>
      <button class="btn primary" onclick="saveProfile()">Save Profile</button>
    </div>
    <aside class="card">
      <h4>My Posts</h4>
      <div id="myPosts" class="list"></div>
    </aside>
  </section>
</main>

<script>
/* ===== Firebase Config (from you) ===== */
const firebaseConfig = {
  apiKey: "AIzaSyD9FS8GY4KEXxz_-g8KVosq4vqALo7q4pE",
  authDomain: "gymsocial-68dac.firebaseapp.com",
  projectId: "gymsocial-68dac",
  storageBucket: "gymsocial-68dac.firebasestorage.app",
  messagingSenderId: "885703262759",
  appId: "1:885703262759:web:8306ed30ca18f42392c402",
  measurementId: "G-7TBXBYQ4FK"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

/* ===== Simple Router (tabs) ===== */
const screens = ["auth","feed","upload","stories","messages","discover","requests","profile"];
const tabs = document.querySelectorAll('.tab[data-screen]');
tabs.forEach(t=>t.addEventListener('click',()=>show(t.dataset.screen)));
document.getElementById('logoutBtn').onclick = () => auth.signOut();

function show(name){
  screens.forEach(s=>document.getElementById(s)?.classList.add('hidden'));
  document.getElementById(name)?.classList.remove('hidden');
  tabs.forEach(t=>t.classList.toggle('active', t.dataset.screen===name));
}

/* ===== Auth state ===== */
let me=null, meProfile=null, unsubFeed=null, unsubStories=null, dmUnsub=null;
auth.onAuthStateChanged(async user=>{
  if(!user){
    me=null; meProfile=null;
    show('auth');
    return;
  }
  me=user;
  await ensureUserDoc();
  await loadMeProfile();
  bootLiveUI();
});

/* ===== Initial UI ===== */
show('auth');

/* ===== Helpers ===== */
const byId = id=>document.getElementById(id);
const now = ()=>firebase.firestore.Timestamp.now();
function limit(val, max){ return Math.max(0, Math.min(Number(val||0), max)); }
function userRef(uid){ return db.collection('users').doc(uid); }

/* ===== User bootstrap ===== */
async function ensureUserDoc(){
  const ref = userRef(me.uid);
  const snap = await ref.get();
  if(!snap.exists){
    await ref.set({
      email: me.email || "",
      displayName: me.email.split('@')[0],
      photoURL: "",
      isPrivate:false,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }
}
async function loadMeProfile(){
  const snap = await userRef(me.uid).get();
  meProfile = snap.data();
  renderMeCard();
}

/* ===== Auth actions ===== */
function register(){
  const email = byId('email').value.trim();
  const pw = byId('password').value.trim();
  auth.createUserWithEmailAndPassword(email,pw).catch(e=>alert(e.message));
}
function login(){
  const email = byId('email').value.trim();
  const pw = byId('password').value.trim();
  auth.signInWithEmailAndPassword(email,pw).catch(e=>alert(e.message));
}

/* ===== Profile ===== */
async function uploadAvatar(){
  if(!me) return;
  const file = byId('avatarFile').files[0];
  if(!file) return alert('Choose an image');
  const ref = storage.ref().child(`avatars/${me.uid}/${Date.now()}_${file.name}`);
  await ref.put(file);
  const url = await ref.getDownloadURL();
  await userRef(me.uid).update({photoURL:url});
  await loadMeProfile();
  alert('Avatar updated');
}
async function saveProfile(){
  if(!me) return;
  const data = {
    displayName: byId('displayName').value.trim() || meProfile?.displayName || me.email.split('@')[0],
    isPrivate: byId('isPrivate').value === 'true',
    height: Number(byId('height').value||0),
    weight: Number(byId('weight').value||0),
    age: Number(byId('age').value||0),
    bench: limit(byId('bench').value,300),
    squat: limit(byId('squat').value,300),
    pullups: limit(byId('pullups').value,70),
    pushups: limit(byId('pushups').value,200),
  };
  await userRef(me.uid).set({...meProfile, ...data}, {merge:true});
  await loadMeProfile();
  alert('Profile saved');
}
function renderMeCard(){
  if(!me) return;
  byId('profileAvatar').src = meProfile?.photoURL || '';
  byId('displayName').value = meProfile?.displayName || '';
  byId('isPrivate').value = String(!!meProfile?.isPrivate);
  byId('meCard').innerHTML = `
    <div class="row" style="align-items:center">
      <img class="avatar" src="${meProfile?.photoURL||''}" alt="">
      <div>
        <div><b>${meProfile?.displayName||''}</b></div>
        <div class="muted">${me.email}</div>
        <div class="muted">${meProfile?.isPrivate?'Private':'Public'} account</div>
      </div>
    </div>
    <div class="hr"></div>
    <div class="row">
      <div class="chip">H: ${meProfile?.height||0} cm</div>
      <div class="chip">W: ${meProfile?.weight||0} kg</div>
      <div class="chip">Age: ${meProfile?.age||0}</div>
    </div>
    <div class="row">
      <div class="chip">Bench ${meProfile?.bench||0}</div>
      <div class="chip">Squat ${meProfile?.squat||0}</div>
      <div class="chip">Pull-ups ${meProfile?.pullups||0}</div>
      <div class="chip">Push-ups ${meProfile?.pushups||0}</div>
    </div>`;
}

/* ===== Upload Post ===== */
async function createPost(){
  if(!me) return;
  const file = byId('postImage').files[0];
  const caption = byId('postCaption').value.trim();
  if(!file) return alert('Choose an image');
  const ref = storage.ref().child(`posts/${me.uid}/${Date.now()}_${file.name}`);
  await ref.put(file);
  const url = await ref.getDownloadURL();
  await db.collection('posts').add({
    uid: me.uid,
    author: meProfile?.displayName || me.email,
    authorPhoto: meProfile?.photoURL || '',
    imageUrl: url,
    caption,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    likeCount: 0
  });
  byId('postImage').value="";
  byId('postCaption').value="";
  alert('Post published');
}

/* ===== Stories (24h) ===== */
async function createStory(){
  if(!me) return;
  const file = byId('storyImage').files[0];
  if(!file) return alert('Choose an image');
  const ref = storage.ref().child(`stories/${me.uid}/${Date.now()}_${file.name}`);
  await ref.put(file);
  const url = await ref.getDownloadURL();
  const exp = firebase.firestore.Timestamp.fromDate(new Date(Date.now()+24*60*60*1000));
  await db.collection('stories').add({
    uid: me.uid,
    author: meProfile?.displayName || me.email,
    authorPhoto: meProfile?.photoURL || '',
    imageUrl: url,
    expiresAt: exp,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  alert('Story added');
}

/* ===== Follow / Requests =====
 users/{uid}:
   followers: collection of {uid:true}
   following: collection of {uid:true}
   requests:  incoming follow requests docs {fromUid, createdAt}
*/
async function follow(targetUid, isTargetPrivate){
  if(targetUid===me.uid) return;
  if(isTargetPrivate){
    // send request
    await userRef(targetUid).collection('requests').doc(me.uid).set({
      fromUid: me.uid, fromEmail: me.email, fromName: meProfile?.displayName||me.email,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert('Follow request sent');
  }else{
    // instant follow
    await userRef(me.uid).collection('following').doc(targetUid).set({uid:targetUid});
    await userRef(targetUid).collection('followers').doc(me.uid).set({uid:me.uid});
    alert('Following');
  }
}
async function acceptRequest(fromUid){
  await userRef(me.uid).collection('requests').doc(fromUid).delete();
  await userRef(me.uid).collection('followers').doc(fromUid).set({uid:fromUid});
  await userRef(fromUid).collection('following').doc(me.uid).set({uid:me.uid});
}
async function denyRequest(fromUid){
  await userRef(me.uid).collection('requests').doc(fromUid).delete();
}

/* ===== Feed (only people I follow + myself) ===== */
function bootLiveUI(){
  show('feed');
  // stories bar
  if (unsubStories) unsubStories();
  unsubStories = db.collection('stories')
    .where('expiresAt','>', now())
    .orderBy('expiresAt','desc')
    .onSnapshot(s=>{
      const bar = byId('storiesBar'); bar.innerHTML='';
      s.forEach(doc=>{
        const d=doc.data();
        const el=document.createElement('div');
        el.className='story';
        el.innerHTML=`<img src="${d.authorPhoto||''}" alt=""><div class="muted" style="font-size:.8em">${d.author}</div>`;
        el.onclick=()=>window.open(d.imageUrl,'_blank');
        bar.appendChild(el);
      });
    });

  // feed posts
  if (unsubFeed) unsubFeed();
  // first, get following list
  userRef(me.uid).collection('following').onSnapshot(async snap=>{
    const uids = new Set([me.uid]);
    snap.forEach(d=>uids.add(d.id));
    if(unsubFeed) unsubFeed();
    unsubFeed = db.collection('posts')
      .where('uid','in', Array.from(uids).slice(0,10)) // Firestore in() limit 10
      .orderBy('createdAt','desc')
      .onSnapshot(renderFeed);
  });

  // users list
  db.collection('users').onSnapshot(renderUsers);

  // my posts
  db.collection('posts').where('uid','==',me.uid).orderBy('createdAt','desc')
    .onSnapshot(s=>{
      const wrap=byId('myPosts'); wrap.innerHTML='';
      s.forEach(doc=>{
        const p=doc.data();
        wrap.appendChild(postMini(doc.id,p));
      });
    });

  // requests
  userRef(me.uid).collection('requests').orderBy('createdAt','desc').onSnapshot(s=>{
    const box=byId('reqList'); box.innerHTML='';
    if(s.empty) box.innerHTML='<div class="muted">No pending requests</div>';
    s.forEach(d=>{
      const r=d.data();
      const row=document.createElement('div');
      row.className='card';
      row.innerHTML=`<b>${r.fromName||r.fromEmail}</b> wants to follow you.
        <div class="row" style="margin-top:8px">
          <button class="btn primary">Accept</button>
          <button class="btn danger">Decline</button>
        </div>`;
      row.querySelector('.btn.primary').onclick=()=>acceptRequest(d.id);
      row.querySelector('.btn.danger').onclick=()=>denyRequest(d.id);
      box.appendChild(row);
    });
  });
}
function renderFeed(snap){
  const list = byId('feedList'); list.innerHTML='';
  if(snap.empty) list.innerHTML='<div class="card muted">No posts yet. Follow users or create your first post from Upload tab.</div>';
  snap.forEach(doc=>{
    const p = doc.data();
    list.appendChild(postCard(doc.id,p));
  });
}
function postMini(id,p){
  const el=document.createElement('div');
  el.className='post';
  el.innerHTML=`<div class="top"><img class="avatar" src="${p.authorPhoto||''}"/>
      <div><b>${p.author}</b><div class="muted" style="font-size:.85em">${p.caption||''}</div></div>
    </div>
    <img class="media" src="${p.imageUrl}">
    <div class="actions"><span class="muted">${(p.createdAt&&p.createdAt.toDate().toLocaleString())||''}</span></div>`;
  return el;
}
function postCard(id,p){
  const wrap=document.createElement('div'); wrap.className='post';
  wrap.innerHTML=`
    <div class="top">
      <img class="avatar" src="${p.authorPhoto||''}" alt="">
      <div><b>${p.author}</b><div class="muted">${p.caption||''}</div></div>
    </div>
    <img class="media" src="${p.imageUrl}" alt="">
    <div class="actions">
      <button class="btn" id="like-${id}">♥ Like</button>
      <span class="muted" id="likecount-${id}">${p.likeCount||0} likes</span>
    </div>
    <div style="padding:10px">
      <div id="comments-${id}" class="list"></div>
      <div class="row">
        <div><input id="cmt-${id}" placeholder="Add a comment..."></div>
        <div><button class="btn" id="sendcmt-${id}">Post</button></div>
      </div>
    </div>`;
  // like logic
  const likeBtn = wrap.querySelector(`#like-${id}`);
  likeBtn.onclick = ()=>toggleLike(id);
  // comments live
  db.collection('posts').doc(id).collection('comments').orderBy('createdAt')
    .onSnapshot(cs=>{
      const box = wrap.querySelector('#comments-'+id); box.innerHTML='';
      cs.forEach(d=>{
        const c=d.data();
        const row=document.createElement('div');
        row.innerHTML=`<b>${c.author}</b> <span class="muted">${c.text}</span>`;
        box.appendChild(row);
      });
    });
  wrap.querySelector('#sendcmt-'+id).onclick = ()=>{
    const txt = wrap.querySelector('#cmt-'+id).value.trim();
    if(!txt) return;
    db.collection('posts').doc(id).collection('comments').add({
      uid: me.uid, author: meProfile?.displayName || me.email, text: txt,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    wrap.querySelector('#cmt-'+id).value='';
  }
  // live like count
  db.collection('posts').doc(id).onSnapshot(d=>{
    const v=d.data(); wrap.querySelector('#likecount-'+id).textContent=`${v.likeCount||0} likes`;
  });
  return wrap;
}
async function toggleLike(postId){
  const likeDoc = db.collection('posts').doc(postId).collection('likes').doc(me.uid);
  const snap = await likeDoc.get();
  const postRef = db.collection('posts').doc(postId);
  return db.runTransaction(async tx=>{
    const pSnap = await tx.get(postRef);
    let count = pSnap.data().likeCount||0;
    if(snap.exists){
      tx.delete(likeDoc); count=Math.max(0,count-1);
    }else{
      tx.set(likeDoc, {uid:me.uid, at: firebase.firestore.FieldValue.serverTimestamp()});
      count=count+1;
    }
    tx.update(postRef,{likeCount:count});
  });
}

/* ===== Discover Users list ===== */
function renderUsers(snap){
  const box = byId('userList'); box.innerHTML='';
  snap.forEach(d=>{
    const u=d.data(); const uid=d.id;
    if(!u.email) return;
    const row=document.createElement('div');
    row.className='card';
    row.innerHTML=`
      <div class="row" style="align-items:center">
        <img class="avatar" src="${u.photoURL||''}">
        <div style="flex:1">
          <div><b>${u.displayName||u.email}</b> ${u.isPrivate?'<span class="chip">Private</span>':'<span class="chip">Public</span>'}</div>
          <div class="muted">${u.email}</div>
        </div>
        <button class="btn" ${uid===me?.uid?'disabled':''}>${u.isPrivate?'Request Follow':'Follow'}</button>
      </div>`;
    row.querySelector('.btn').onclick=()=>follow(uid, !!u.isPrivate);
    // open chat shortcut
    const chatLink=document.createElement('div');
    chatLink.className='link muted'; chatLink.textContent='Message';
    chatLink.onclick=()=>{ byId('dmToEmail').value=u.email; show('messages'); openConversation(); };
    row.appendChild(chatLink);
    box.appendChild(row);
  });
}

/* ===== Direct Messages (1-1) =====
   conversations/{convId} where convId = sorted(uid1_uid2)
   messages subcollection
*/
let currentConvId=null, currentPeer=null;
function convIdFor(a,b){ return [a,b].sort().join('_'); }
async function openConversation(){
  const email = byId('dmToEmail').value.trim();
  if(!email || !me) return;
  const q = await db.collection('users').where('email','==',email).limit(1).get();
  if(q.empty) return alert('User not found');
  currentPeer = { uid: q.docs[0].id, ...q.docs[0].data() };
  currentConvId = convIdFor(me.uid, currentPeer.uid);
  byId('dmHeader').innerHTML = `Chat with <b>${currentPeer.displayName||currentPeer.email}</b>`;
  byId('dmBox').classList.remove('hidden');
  if(dmUnsub) dmUnsub();
  dmUnsub = db.collection('conversations').doc(currentConvId).collection('messages')
    .orderBy('createdAt').onSnapshot(s=>{
      const box=byId('dmMessages'); box.innerHTML='';
      s.forEach(d=>{
        const m=d.data();
        const mine = m.uid===me.uid;
        const row=document.createElement('div');
        row.style.margin='6px 0';
        row.style.textAlign = mine ? 'right':'left';
        row.innerHTML = `<span class="chip" style="background:${mine?'#102b3a':'#1b2237'}">${m.text}</span>`;
        box.appendChild(row);
      });
      const el=byId('dmMessages'); el.scrollTop=el.scrollHeight;
    });
}
async function sendDM(){
  if(!currentConvId || !me) return;
  const txt = byId('dmInput').value.trim();
  if(!txt) return;
  await db.collection('conversations').doc(currentConvId).collection('messages').add({
    uid: me.uid, text: txt, createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  byId('dmInput').value='';
}

/* ===== Stories screen (viewer) ===== */
document.querySelector('[data-screen="stories"]').addEventListener('click', ()=>{
  // when switching to stories tab, open a simple viewer modal (use stories bar link behavior for now)
  show('upload'); // stories managed in Upload; viewer is in feed top bar
});
</script>

</body>
</html>
