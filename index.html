<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Talk2Translate</title>
<style>
  :root {
    --bg1:#0f172a; --bg2:#1e293b; --glass:rgba(255,255,255,.08);
    --text:#f1f5f9; --muted:#94a3b8; --accent:#ec4899;
    --line:rgba(255,255,255,.12);
  }
  *{box-sizing:border-box}
  body {margin:0;font-family:sans-serif;
    background:linear-gradient(180deg,var(--bg1),var(--bg2));
    color:var(--text);display:flex;justify-content:center;padding:20px;}
  .wrap {width:min(900px,100%)}
  .card {background:var(--glass);border:1px solid var(--line);
    border-radius:18px;padding:18px;backdrop-filter:blur(16px);}
  header{display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:14px}
  h1{margin:0;font-size:22px}
  .badges{display:flex;gap:6px;flex-wrap:wrap}
  .badge{font-size:12px;padding:5px 10px;border-radius:999px;border:1px solid var(--line)}
  .ok{background:rgba(16,185,129,.15)}
  .warn{background:rgba(251,191,36,.15)}
  .err{background:rgba(239,68,68,.15)}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px}
  select,button,textarea{border:none;border-radius:12px;padding:10px;font-size:15px;color:var(--text);background:rgba(255,255,255,.09)}
  button{cursor:pointer;background:linear-gradient(135deg,var(--accent),#8b5cf6);font-weight:600}
  button.secondary{background:rgba(255,255,255,.09);border:1px solid var(--line)}
  button:disabled{opacity:.5;cursor:not-allowed}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media(max-width:860px){.grid{grid-template-columns:1fr}}
  .box{background:rgba(255,255,255,.06);border:1px solid var(--line);border-radius:16px;padding:12px;min-height:120px;display:flex;flex-direction:column}
  .box h3{margin:0 0 8px;font-size:14px;color:var(--muted)}
  .view{flex:1;background:rgba(0,0,0,.25);border-radius:12px;padding:10px;overflow:auto}
  textarea{width:100%;resize:vertical;min-height:90px}
  .bar{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  footer{margin-top:14px;font-size:12px;color:var(--muted);text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <h1>🎤 Talk2Translate</h1>
      <div class="badges">
        <span id="httpsBadge" class="badge">HTTPS kontrol...</span>
        <span id="srBadge" class="badge">SR kontrol...</span>
        <span id="micBadge" class="badge">Mikrofon...</span>
      </div>
    </header>

    <div class="controls">
      <select id="sourceLang">
        <option value="tr-TR" data-iso="tr" selected>Türkçe</option>
        <option value="en-US" data-iso="en">İngilizce</option>
        <option value="de-DE" data-iso="de">Almanca</option>
        <option value="fr-FR" data-iso="fr">Fransızca</option>
        <option value="es-ES" data-iso="es">İspanyolca</option>
        <option value="ru-RU" data-iso="ru">Rusça</option>
        <option value="ar-SA" data-iso="ar">Arapça</option>
      </select>
      <select id="targetLang">
        <option value="en">İngilizce</option>
        <option value="tr">Türkçe</option>
        <option value="de">Almanca</option>
        <option value="fr">Fransızca</option>
        <option value="es">İspanyolca</option>
        <option value="ru">Rusça</option>
        <option value="ar">Arapça</option>
      </select>
      <button id="startBtn">Başlat</button>
      <button id="stopBtn" class="secondary" disabled>Durdur</button>
      <label><input type="checkbox" id="autoSpeak" checked> Otomatik Oku</label>
      <button id="speakBtn" class="secondary" disabled>Oku</button>
    </div>

    <div class="grid">
      <div class="box"><h3>Algılanan</h3><div id="recognizedText" class="view">—</div></div>
      <div class="box"><h3>Çevrilen</h3><div id="translatedText" class="view">—</div></div>
    </div>

    <div class="box" style="margin-top:14px">
      <h3>Manuel Mod</h3>
      <textarea id="manualInput" placeholder="Metni yaz..."></textarea>
      <div class="bar">
        <button id="manualTranslateBtn">Çevir</button>
        <span id="lastError" class="badge">Son hata: yok</span>
      </div>
    </div>

    <footer>Ücretsiz çeviri: MyMemory • Chrome/Edge + HTTPS önerilir.</footer>
  </div>
</div>

<script>
const recognizedEl = document.getElementById('recognizedText');
const translatedEl = document.getElementById('translatedText');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const speakBtn = document.getElementById('speakBtn');
const autoSpeak = document.getElementById('autoSpeak');
const manualInput = document.getElementById('manualInput');
const manualTranslateBtn = document.getElementById('manualTranslateBtn');
const sourceSel = document.getElementById('sourceLang');
const targetSel = document.getElementById('targetLang');
const httpsBadge = document.getElementById('httpsBadge');
const srBadge = document.getElementById('srBadge');
const micBadge = document.getElementById('micBadge');
const lastErrorEl = document.getElementById('lastError');

const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
let lastTranslated = '';
let recognition = null;
let silenceTimer = null;

// Rozetler
const setBadge = (el, text, cls) => { el.className = `badge ${cls||''}`; el.textContent = text; };
const setError = (msg) => lastErrorEl.textContent = `Son hata: ${msg}`;
const isHttps = location.protocol === 'https:' || ['localhost','127.0.0.1'].includes(location.hostname);
setBadge(httpsBadge, isHttps ? 'HTTPS ✔' : 'HTTPS gerekli', isHttps ? 'ok' : 'warn');
if (SR) setBadge(srBadge, 'SpeechRecognition ✔', 'ok'); else setBadge(srBadge, 'SR destek yok', 'err');
navigator.mediaDevices.getUserMedia({audio:true}).then(()=>setBadge(micBadge,'Mikrofon ✔','ok')).catch(()=>setBadge(micBadge,'Mikrofon yok','err'));

// Çeviri
async function translateText(text, sourceISO, targetISO) {
  translatedEl.textContent = 'Çevriliyor...';
  try {
    const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceISO}|${targetISO}`);
    const data = await res.json();
    const out = data?.responseData?.translatedText || '';
    if (!out) throw new Error('Boş çeviri');
    translatedEl.textContent = out;
    lastTranslated = out;
    speakBtn.disabled = false;
    setError('yok');
    if (autoSpeak.checked) speakNow();
  } catch(e) {
    translatedEl.textContent = 'Çeviri hatası!';
    speakBtn.disabled = true;
    setError(e.message || 'Çeviri hatası');
  }
}

// Oku
function speakNow(){
  if (!lastTranslated) return;
  const u = new SpeechSynthesisUtterance(lastTranslated);
  u.lang = targetSel.value;
  speechSynthesis.speak(u);
}
speakBtn.addEventListener('click', speakNow);

// Manuel mod
manualTranslateBtn.addEventListener('click', ()=>{
  const text = manualInput.value.trim();
  if (!text) return;
  recognizedEl.textContent = text;
  translateText(text, sourceSel.selectedOptions[0].dataset.iso, targetSel.value);
});

// Dinleme
startBtn.addEventListener('click', async ()=>{
  if (!SR) { setError('Destek yok'); return; }
  try { await navigator.mediaDevices.getUserMedia({audio:true}); } catch { setError('Mic izni yok'); return; }

  recognition = new SR();
  recognition.lang = sourceSel.value;
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  recognition.continuous = false; // Android uyumu

  recognition.onstart = () => {
    console.log('🎤 Dinleme başladı, dil:', recognition.lang);
    recognizedEl.textContent = 'Dinleniyor...';
    startBtn.disabled = true;
    stopBtn.disabled = false;
    silenceTimer = setTimeout(()=>recognition.stop(), 5000);
  };
  recognition.onspeechend = () => {
    console.log('🛑 Konuşma sona erdi');
    clearTimeout(silenceTimer);
    recognition.stop();
  };
  recognition.onresult = (e) => {
    clearTimeout(silenceTimer);
    const transcript = e.results[0][0].transcript.trim();
    console.log('📜 Algılanan metin:', transcript);
    if (transcript) {
      recognizedEl.textContent = transcript;
      translateText(transcript, sourceSel.selectedOptions[0].dataset.iso, targetSel.value);
    } else {
      recognizedEl.textContent = 'Hiç ses algılanmadı';
      setError('Boş sonuç');
    }
  };
  recognition.onerror = (e) => {
    clearTimeout(silenceTimer);
    console.error('❌ Hata:', e.error);
    recognizedEl.textContent = `Hata: ${e.error}`;
    setError(e.error);
  };
  recognition.onend = () => {
    console.log('🔚 Dinleme sona erdi');
    clearTimeout(silenceTimer);
    startBtn.disabled = false;
    stopBtn.disabled = true;
  };

  recognition.start();
});
stopBtn.addEventListener('click', ()=>{
  if (recognition) { clearTimeout(silenceTimer); recognition.stop(); }
});
</script>
</body>
</html>
